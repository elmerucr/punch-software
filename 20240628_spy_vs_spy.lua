-- Newer version 20240628

local color = 10

function init()
  -- make blitter cause interrupts at start of frame
  -- this will call the lua function frame()
  pokeb(0x801, 1)

  -- timer stuff
  pokew(0xa10, 3008)
  pokeb(0xa01, 1)

  -- set pulse width
  pokew(0xc02, 0x0f0f)
  pokew(0xc0a, 0x0f0f)

  co = coroutine.create(do_sound)
end

function timer0()
	coroutine.resume(co)
end

function frame()
  pokeb(0xe05, color)	-- target color
  pokeb(0xe03, 0xf)	-- target surface = 0xf
  pokeb(0xe01, 4)	-- clear surface command
  color = color + 1
  if color == 20 then color = 10 end
end

-- Spy vs Spy I track 1
-- 0x000 means note not played
local track1 = {
    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x03e0, 0x07c1, 0x0b9d, 0x0f81, 0x03e0, 0x07c1, 0x0000, 0x0000,
    0x0342, 0x0685, 0x09c4, 0x0d0a, 0x0342, 0x0685, 0x0000, 0x0000,
    0x045a, 0x08b4, 0x0d0a, 0x1167, 0x03a9, 0x0751, 0x0af7, 0x0ea2,

    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x03e0, 0x07c1, 0x0b9d, 0x0f81, 0x03e0, 0x07c1, 0x0000, 0x0000,
    0x0342, 0x0685, 0x09c4, 0x0d0a, 0x0342, 0x0685, 0x0000, 0x0000,
    0x045a, 0x08b4, 0x0d0a, 0x1167, 0x03a9, 0x0751, 0x0af7, 0x0ea2,

    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x03e0, 0x07c1, 0x0b9d, 0x0f81, 0x03e0, 0x07c1, 0x0000, 0x0000,
    0x0342, 0x0685, 0x09c4, 0x0d0a, 0x0342, 0x0685, 0x0000, 0x0000,
    0x045a, 0x08b4, 0x0d0a, 0x1167, 0x03a9, 0x0751, 0x0af7, 0x0ea2
}

-- Spy vs Spy I track 2
-- 0x000 means note not played
local track2 = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,

    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,

    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000,
    0x04e2, 0x09c4, 0x0ea2, 0x1389, 0x04e2, 0x09c4, 0x0000, 0x0000
}

function do_sound()
	while true do
		for i=1, #track1 do
			-- channel 1
			if track1[i] ~= 0 then
				pokew(0xc80, track1[i])
				pokeb(0xc85, 0x04)
				pokeb(0xc86, 0x15)
				pokeb(0xc84, 0x41)
			end
			-- channel 2
			if track2[i] ~= 0 then
				pokew(0xc88, track2[i])
				pokeb(0xc8d, 0x04)
				pokeb(0xc8e, 0x15)
				pokeb(0xc8c, 0x41)
			end

			for j=1, 10 do
				if j==9 then
					pokeb(0xc85, 0x00)
					pokeb(0xc86, 0x00)
					pokeb(0xc84, 0x40)

					pokeb(0xc8d, 0x00)
					pokeb(0xc8e, 0x00)
					pokeb(0xc8c, 0x40)
				end
				coroutine.yield()
			end
		end
	end
end
